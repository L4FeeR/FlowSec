<!DOCTYPE html>
<html>
<head>
    <title>Encryption Test</title>
</head>
<body>
    <h1>FlowSec Encryption Test</h1>
    <div>
        <input type="text" id="testMessage" placeholder="Enter a message" value="hello world">
        <button onclick="testEncryption()">Test Encryption</button>
    </div>
    <div id="results"></div>

    <script>
        // Copy encryption functions from dashboard.js
        async function getChatKey(chatId) {
            let key = localStorage.getItem('chatKey-' + chatId);
            if (!key) {
                key = await window.crypto.subtle.generateKey({ name: 'AES-GCM', length: 256 }, true, ['encrypt', 'decrypt']);
                const jwk = await window.crypto.subtle.exportKey('jwk', key);
                localStorage.setItem('chatKey-' + chatId, JSON.stringify(jwk));
                return key;
            }
            return await window.crypto.subtle.importKey('jwk', JSON.parse(key), { name: 'AES-GCM' }, true, ['encrypt', 'decrypt']);
        }

        async function encryptMessage(chatId, text) {
            const key = await getChatKey(chatId);
            const iv = window.crypto.getRandomValues(new Uint8Array(12));
            const enc = new TextEncoder().encode(text);
            const ciphertext = await window.crypto.subtle.encrypt({ name: 'AES-GCM', iv }, key, enc);
            return btoa(String.fromCharCode(...iv) + String.fromCharCode(...new Uint8Array(ciphertext)));
        }

        async function decryptMessage(chatId, encrypted) {
            const key = await getChatKey(chatId);
            const data = atob(encrypted);
            const iv = Uint8Array.from(data.slice(0, 12), c => c.charCodeAt(0));
            const ct = Uint8Array.from(data.slice(12), c => c.charCodeAt(0));
            const dec = await window.crypto.subtle.decrypt({ name: 'AES-GCM', iv }, key, ct);
            return new TextDecoder().decode(dec);
        }

        async function testEncryption() {
            const message = document.getElementById('testMessage').value;
            const testChatId = 'test-chat-123';
            const results = document.getElementById('results');
            
            try {
                console.log('Testing encryption for:', message);
                
                // Test encryption
                const encrypted = await encryptMessage(testChatId, message);
                console.log('Encrypted:', encrypted);
                
                // Test decryption
                const decrypted = await decryptMessage(testChatId, encrypted);
                console.log('Decrypted:', decrypted);
                
                results.innerHTML = `
                    <h3>Test Results:</h3>
                    <p><strong>Original:</strong> ${message}</p>
                    <p><strong>Encrypted:</strong> ${encrypted}</p>
                    <p><strong>Decrypted:</strong> ${decrypted}</p>
                    <p><strong>Success:</strong> ${message === decrypted ? 'YES' : 'NO'}</p>
                `;
            } catch (error) {
                console.error('Encryption test failed:', error);
                results.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
            }
        }
    </script>
</body>
</html>